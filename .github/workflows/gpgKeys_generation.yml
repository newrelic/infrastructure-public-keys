name: GPG Key Generation (Test)

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message to display'
        required: false
        default: 'Hello from GPG workflow test!'
        type: string
  push:
    branches:
      - gpgWorkflow

jobs:
  generate-gpg-keys:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GPG
        run: |
          echo "GPG Version:"
          gpg --version
          echo "Creating GPG directory..."
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
      
      - name: Generate GPG Keys
        env:
          OHAI_GPG_PASSPHRASE: ${{ secrets.OHAI_GPG_PASSPHRASE }}
          GPG_KEY_NAME: "New Relic Infrastructure Agent"
          GPG_KEY_EMAIL: "infrastructure-eng@newrelic.com"
        run: |
          chmod +x .github/workflows/scripts/gpgKeys_generation.sh
          .github/workflows/scripts/gpgKeys_generation.sh
      
      - name: Verify generated keys
        run: |
          echo "Verifying generated files..."
          ls -lh gpg-*.asc
          echo ""
          echo "Public key preview:"
          head -n 5 gpg-public-key.asc
          echo ""
          echo "Keys generated successfully!"      
      
      - name: Upload private key to GitHub Secrets
        env:
          GH_TOKEN: ${{ secrets.OHAI_PAT }}
        run: |
          echo "Installing GitHub CLI..."
          type -p gh &> /dev/null || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y)
          
          echo "Encoding private key to base64..."
          ENCODED_KEY=$(cat gpg-private-key.asc | base64 -w 0)
          
          echo "Uploading encoded private key to GitHub organization secret..."
          gh secret set OHAI_GPG_PRIVATE_SHA256 --body "${ENCODED_KEY}" --org newrelic --visibility all
          
          echo "✓ Private key (base64 encoded) uploaded to GitHub organization secret: OHAI_GPG_PRIVATE_SHA256"
      
      - name: Export GPG key in binary format
        run: |
          echo "Getting Key ID..."
          KEY_ID=$(gpg --list-keys --with-colons "infrastructure-eng@newrelic.com" | awk -F: '/^pub:/ {print $5}' | head -n 1)
          echo "Key ID: ${KEY_ID}"
          
          echo "Exporting public key in .gpg binary format..."
          gpg --export "${KEY_ID}" > public-key.gpg
          ls -lh public-key.gpg
          echo "✓ Binary GPG key exported"
      
      - name: Copy public keys to gpg/keys folder
        run: |
          echo "Getting Key ID..."
          KEY_ID=$(gpg --list-keys --with-colons "infrastructure-eng@newrelic.com" | awk -F: '/^pub:/ {print $5}' | head -n 1)
          echo "Key ID: ${KEY_ID}"
          
          echo "Creating directory structure if it doesn't exist..."
          mkdir -p gpg/keys/new
          
          echo "Exporting RPM key..."
          # Export for RPM (RedHat/CentOS/Fedora)
          gpg --export "${KEY_ID}" > gpg/keys/new/newrelic_rpm_key_new.gpg
          
          echo "Generated key in gpg/keys/new/:"
          ls -lh gpg/keys/new/
          echo "✓ Public RPM key exported to gpg/keys/new/ folder"
      
      - name: Commit public keys to repository
        env:
          GH_TOKEN: ${{ secrets.OHAI_PAT }}
        run: |
          echo "Configuring git..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "Adding generated key..."
          git add gpg/keys/new/newrelic_rpm_key_new.gpg
          
          echo "Committing changes..."
          git commit -m "Add generated GPG public key to gpg/keys/new folder" || echo "No changes to commit"
          
          echo "Pushing to repository..."
          git push
          
          echo "✓ Public RPM key committed to gpg/keys/new/ folder"
          echo "✓ File available at: gpg/keys/new/newrelic_rpm_key_new.gpg"

